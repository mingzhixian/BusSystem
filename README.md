# 重庆北碚公交线路换乘推荐系统

## 目的

根据用户所在站和目的站提供最佳换乘结果。提供步行最少优先以及时间最短优先两种模式。

## 部署

1. 根据实际情况修改siteInfo中的站点信息（格式参考siteInfo/rule.md）

2. 编译软件

```shell
make
```

3. 运行软件（守护进程）

```shell
./out/busSystem
```

**二三步也可以使用以下命令代替**

```shell
make run
```

4. 测试

```shell
make testUsr
```

## 使用

项目启动后会启动后台守护进程，如需访问需要进程间通信，输入请求通过“/tmp/BusSystemFifoIn”通道，获取返回值通过“/tmp/BusSystemFifoOut”通道。

- 访问数据格式：{"id":"1","source":"西南大学站","purpose":"解放碑站","mode":"1"}</br>
释义：从西南大学站至解放碑站的换乘方案，时间最短优先,id用于帮助用户区分不同的请求返回值。</br>
mode:1--时间最短优先、2--步行最少优先
- 返回数据格式：{"id":"1","route":[
    {"bus":"4","source":"西南大学站","purpose":"红旗河沟站"},
    {"bus":"-1","source":"红旗河沟站","purpose":"红旗河村站"},
    {"bus":" 8","source":"红旗河村站","purpose":"解放碑站"}],
    "meter":"400",
    "busTime":"20",
    "walkTime":"5"}</br>
释义：从西南大学站乘坐4路公交车前往红旗河沟站，随后从红旗河沟站步行至红旗河村站，再从红旗河村站乘坐8路车至解放碑站。全程步行距离400米，坐车时间20分钟，步行时间5分钟，id用于帮助用户区分不同的请求返回值。

## 项目结构

<pre>
.
├── makefile                                    - make文件
├── README                                      - 项目说明文件 
├── src                                         - 项目源代码文件夹
│   ├── daemon                                      - 守护进程
│   │   └── daemon.cpp                                  - 守护进程主程序
│   ├── dataInfo                                    - 数据处理
│   │   ├── graph.cpp                                   - 图操作相关工作集
│   │   ├── hash.cpp                                    - 哈希链表相关工作集
│   │   └── heap.cpp                                    - 堆处理相关工作集
│   ├── header                                      - 头文件
│   │   ├── daemon.h                                    - 守护进程头文件
│   │   ├── dataInfo.h                                  - 数据处理头文件
│   │   ├── public.h                                    - 公共头文件
│   │   └── siteInfo.h                                  - 线路信息头文件
│   ├── main                                        - 主程序入口
│   │   └── main.cpp                                    - 主程序
│   └── siteInfo                                    - 线路信息处理
│       ├── getinfo.py                                  - 公交信息爬虫示例
│       ├── parseSiteInfo.cpp                           - 线路信息处理相关工作集
│       ├── rule.md                                     - 线路信息文本文件规范
│       ├── siteinfo-test.txt                           - 测试用模仿线路信息文本文件
│       └── siteinfo.txt                                - 线路信息文本文件示例
└── testUsr                                     - 测试用用户端程序
    └── testUsr.cpp                                 - 测试用用户端主程序       
</pre>

## 项目说明

### 数据说明

本程序测试数据包括了重庆市0～399路公交车的信息，涉及1992个站点，数据量已经足够庞大，为提高软件测试速度以及防止爬虫被ban，未爬取所有公交信息。<br><br>

本项目提供了简易的抓取公交信息软件，位置在siteInfo文件夹下的getinfo.py文件，该爬虫爬取的网站提供了重庆1400余条公交线路的信息，测试时本项目仅爬取了400条线路。<br><br>

因作者无法获取精确信息，所以项目中站点之间的所需的时长以及站点之间是否可通过较短的步行到达等信息均为作者随机产生，重点在于程序本身，如有精准数据可以按照siteinfo文件夹下的rule.md中所规定的规则修改siteinfo.txt中信息。<br><br>

### 数据存储

数据的存储使用了图，图的实际存储结构使用了链表式，即图中包括所有的顶点（站点），每个站点中包含站点信息以及一条链表，链表中存储与该站相连的边信息。边中存储该边相连的两个站之间的公交、公交时间、步行距离、步行时间信息。
边有三种情况：第一种为两站点之间无公交运行，但距离较小，可以步行通过；第二种为两站点之间距离很长，无法步行，但有公交运行；第三种两个站点之间距离较小，可以步行过去，同时也有公交运行（在无公交或无法步行时时间均设为极大值）。<br><br>

项目使用了缓存来提高反应速度，缓存使用哈希链表实现，存储两个站点之间最短路径结果。<br><br>

### 最短路径计算方法

使用了Dijkstra算法计算两个站点之间的最短路径，并使用了堆排序进行优化。最短路径的标准有两种，第一种为时间最短优先，此策略在处理边时采用步行时间与公交运行时间中最短的一种方式；第二种策略为步行最短优先，此策略在处理边的第一种情况和第二种情况时仍采用时间最短优先方式，在处理边的第三种情况时以公交为优先。